<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" type="text/css" href="../CSS/home.css">
    <link rel="stylesheet" type="text/css" href="../CSS/fontawesome.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet">
    <!---->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poor+Story&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Stylish&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        
        body {
          
        }
        
        .inner {
            display:flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .changeThings {
            display:flex;
            flex-direction: row;
            justify-content:space-between;
            margin-bottom:0px;
        }
        .widgetMenu {
            display:flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
        }
        table {
            border-spacing: 0px;
            border-color: grey;
            table-layout: fixed;
        }
        .widgetItemBox {
            position:absolute;
            width:80px;
            height:30px;
            border-radius: 10px;
            text-align: center;
            padding-bottom: 20px;
            margin:10px;
        }
        td {
            max-height: 45px;
            min-height: 45px;
            height:45px;
            max-width: 100px;
            min-width: 100px;
            width:100px;
            overflow: visible;
        }
        #webpage {
            width: 1200px; 
            height: 100%;
        }

        #srch {
            position: absolute;
            top: 50%;
            left: 50%;
        }
        #menuholder {
            position: absolute;
            top: 43%;
            left: 50%;
        }
    </style>

<link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
<script>
$( function() {
  $( "#dialog-confirm" ).dialog({
    resizable: false,
    height: "auto",
    width: 400,
    modal: true,
    buttons: {
      "1": function() {
        $( this ).dialog( "close" );
      },
      Cancel: function() {
        $( this ).dialog( "close" );
      }
    }
  });
} );
</script>




</head>
<body>
    <div class="inner">
        <div class="changeThings">
            <p onclick="changeBackgroundColor()" style="margin-right: 100px; cursor:pointer; font-size:20px;">배경 색깔 변경</p>
            <p onclick="changeFont()" style="margin-left: 100px; cursor:pointer; font-size:20px;">글씨체 변경</p>
        </div>

        
        <div class="widgetMenu">
            <div class="widgetItemBox" id="1" style="background-color: #FFADAD; left:200px; top:70px; "><p onclick="add_widget.select('s')">검색창</p></div>
            <div class="widgetItemBox" id="2" style="background-color: #FFD6A5; left:300px; top:70px;"><p onclick="add_widget.select('t')">투두리스트</p></div>
            <div class="widgetItemBox" id="3" style="background-color: #f5f7cf; left:400px; top:70px;"><p onclick="add_widget.select('w')">날씨</p></div>
            <div class="widgetItemBox" id="4" style="background-color: #CAFFBF; left:500px; top:70px;"><p onclick="add_widget.select('c')">캘린더</p></div>
            <div class="widgetItemBox" id="5" style="background-color: #A0C4FF; left:600px; top:70px;"><p onclick="add_widget.select('e')">이메일</p></div>
            <div class="widgetItemBox" id="6" style="background-color: #BDB2FF; left:700px; top:70px;"><p onclick="add_widget.select('i')">이미지</p></div>
            <div class="widgetItemBox" id="7" style="background-color: #FFC6FF; left:800px; top:70px;"><p onclick="add_widget.select('p')">포스트잇</p></div>
        </div>
        
        <!--<div id="setTable"></div>-->
        <div class="contentBox" style="display: grid; border:solid 1px; width:1200px; height:540px; margin-top:100px;">

        </div>
            
        <input type="submit" value="추가 완료" onclick="save()">

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="mypage.js"></script>
    <script src="../JS/home_control.js"></script>
    <script src="addWidget.js"></script>
    <script type="text/javascript">
        
        // localStorage.setItem("access_token", "");
        const request_url = "http://localhost:8000";

        let add_widget_widgets = [];

        function req_get_widget_lists() {
            let access_token = localStorage.getItem("access_token");
        
            return $.ajax({
                url: request_url + `/widgets`,
                method: "GET",
                headers: { Authorization: `jwt ${access_token}` },
                dataType: "json",
            });
        }

        function req_create_widget(widget_type_id, pos_x, pos_y, size_x, size_y, raw_data) {
            let access_token = localStorage.getItem("access_token");

            const req_body = {
                widget_type_id,
                pos_x,
                pos_y,
                size_x,
                size_y,
                raw_data
            };

            return $.ajax({
                url: request_url + `/widgets`,
                method: "POST",
                headers: { Authorization: `jwt ${access_token}` },
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify(req_body),
                dataType: "json",
            });
        }

        function req_delete_widget(id) {
            let access_token = localStorage.getItem("access_token");
        
            return $.ajax({
                url: request_url + `/widgets/${id}`,
                method: "DELETE",
                headers: { Authorization: `jwt ${access_token}` },
                dataType: "json",
            });
        }

        function req_get_page_setting() {
            let access_token = localStorage.getItem("access_token");
        
            return $.ajax({
                url: request_url + `/pagesetting`,
                method: "GET",
                headers: { Authorization: `jwt ${access_token}` },
                dataType: "json",
            });
        }

        function req_set_page_setting(bg_color, font) {
            let access_token = localStorage.getItem("access_token");
            
            const req_body = {
                bg_color,
                font
            };

            console.log(req_body);

            return $.ajax({
                url: request_url + `/pagesetting`,
                method: "PATCH",
                headers: { Authorization: `jwt ${access_token}` },
                contentType: "application/json; charset=UTF-8",
                data: JSON.stringify(req_body),
                dataType: "json",
            });
        }

        $(function() {
            $(".widgetItemBox").draggable({
                drag:function() {
                    var offset=$(this).offset();
                    var xPos=offset.left;
                    var yPos=offset.top;
                    //$(this).text(xPos+" "+yPos);
                    const id = $(this).attr("id");
                    const ele = document.getElementById(id);
                    const widget_size = [
                        undefined,
                        [1200, 135], // 검색창
                        [1060, 240], // 투두
                        [400, 400], // 날씨
                        [400, 135], // 캘린더
                        [400, 180], // 이메일
                        [300, 200], // 이미지
                        [200, 200] // 포스트잇
                    ];

                    ele.style.width = widget_size[parseInt(id)][0] + "px";
                    ele.style.height = widget_size[parseInt(id)][1] + "px";
                    
                    $(this).mouseup(function () {
                        const index = add_widget_widgets.findIndex(val => val.widget_type_id === parseInt(id));
                        if (index !== -1) {
                            add_widget_widgets[index].pos_x = xPos;
                            add_widget_widgets[index].pos_y = yPos;
                            add_widget_widgets[index].size_x = widget_size[parseInt(id)][0];
                            add_widget_widgets[index].size_y = widget_size[parseInt(id)][1];
                        } else {
                            add_widget_widgets.push({
                                widget_type_id: parseInt(id),
                                pos_x: xPos,
                                pos_y: yPos,
                                size_x: widget_size[parseInt(id)][0],
                                size_y: widget_size[parseInt(id)][1]
                            });
                        }
                    })
                }
            });

            $(".widgetItemBox").dblclick(function() {
                const id = $(this).attr("id")
                document.getElementById(id).style.display="none";
                const widget_index = add_widget_widgets.findIndex(val => val.widget_type_id === parseInt(id));
                if (widget_index !== -1) {
                    add_widget_widgets.splice(widget_index, 1);
                }
            });

            load();
        });

        function get_widgets(callback) {
            req_get_widget_lists()
            .done(function (req_body) {
                const widgets = req_body.widgets.map(val => ({
                    widget_id: val.widget_id,
                    widget_type_id: val.widget_type_id,
                    pos_x: val.location.pos[0],
                    pos_y: val.location.pos[1],
                    size_x: val.location.size[0],
                    size_y: val.location.size[1],
                    raw_data: val.raw_data
                }));
                callback(widgets);
            });
        }

        function load() {
            get_widgets(function (res) {
                add_widget_widgets = res;
                for (const widget of add_widget_widgets) {
                    let ele = document.getElementById(widget.widget_type_id.toString())
                    ele.style.width = widget.size_x + "px";
                    ele.style.height = widget.size_y + "px";
                    ele.style.left = widget.pos_x + "px";
                    ele.style.top = widget.pos_y + "px";
                    ele.innerHTML = widget.pos_x + " " + widget.pos_y;
                }
            });

            req_get_page_setting()
            .done(function (body) {
                document.body.style.backgroundColor = body.bg_color;
                document.body.style.fontFamily = body.font;
            });
        }

        function save() {
            var colorInfo=document.body.style.backgroundColor; //배경색깔
            var fontInfo=document.body.style.fontFamily; //폰트
            // 배경, 폰트 저장 API 호출
            req_set_page_setting(colorInfo, fontInfo);
            
            get_widgets(function (res) {
                // 기존 위젯 모두 삭제
                const delete_req = [];
                const create_req = [];

                for (const widget of res) {
                    delete_req.push(req_delete_widget(widget.widget_id));
                }

                $.when(...delete_req).done(function () {
                    // add_widget_widgets 에 있는 목록 생성
                    for (const widget of add_widget_widgets) {
                        create_req.push(req_create_widget(
                            widget.widget_type_id,
                            widget.pos_x,
                            widget.pos_y,
                            widget.size_x,
                            widget.size_y,
                            widget.raw_data === null ? undefined : widget.raw_data
                        ));
                    }

                    $.when(...create_req).done(function () {
                        window.location.replace("../please.html");
                    });
                });
            });
        }
        

    </script>
</body>
</html>